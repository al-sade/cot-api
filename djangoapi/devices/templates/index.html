<!DOCTYPE html>
<html lang="en">
 <head>
 <meta charset="utf-8">
 <title>Vue-js | Django | Crud App</title>
 <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
      body{
          font-family: sans-serif;
      }
      #overlay {
        position: fixed; /* Sit on top of the page content */
        width: 100%; /* Full width (cover the whole page) */
        height: 100%; /* Full height (cover the whole page) */
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5); /* Black background with opacity */
        z-index: 2; /* Specify a stack order in case you're using a different order for other elements */
        cursor: pointer; /* Add a pointer on hover */
    }
  </style>
  <!-- import CSS -->
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">

</head>
<body>
<div id="app">
    <h1>List of Devices</h1>

    <div id="overlay" v-show="visible"></div>
        <el-popover  v-model="visible" ref="popover" placement="bottom-start" title="Add Device" trigger="click" width="300">
            <el-form :model="newDevice" status-icon ref="form" class="pop-form">
                <el-form-item>
                    <el-input placeholder="device name" v-model="newDevice.name"></el-input>
                </el-form-item>
                  <el-form-item>
                <el-select v-model="newDevice.properties" placeholder="select properties" multiple>
                  <el-option v-for="property in properties" :label="property.name" :value="property.id"></el-option>
                </el-select>
              </el-form-item>
                <el-form-item>
                    <el-button @click="addDevice" :disabled="_isValidName">Submit</el-button>
                    <el-button @click="visible = false">Cancel</el-button>
                </el-form-item>

            </el-form>
        </el-popover>
        <el-button v-popover:popover2 @click="visible = true">Add Device</el-button>


        <div class="el-row">
            <el-table
              :data="devices"
              style="width: 100%">
              <el-table-column prop="id" label="#">
              </el-table-column>
              <el-table-column prop="name" label="Name">
              </el-table-column>
                <el-table-column prop="properties" label="Properties">
              </el-table-column>
              <el-table-column label="Actions">
                  <template slot-scope="scope">
                      <el-button>Edit</el-button>
                      <el-button @click="deleteDevice(scope.row.id)">Delete</el-button>
                  </template>
              </el-table-column>
          </el-table>
        </div>
      <div class="loading" v-if="loading===true">Loading&#8230;</div>
    </div>

 <!-- vue.js files -->
 <script src="https://cdn.jsdelivr.net/npm/vue@2.5.13/dist/vue.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/vue-resource@1.3.5"></script>
  <!-- import JavaScript -->
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>

<script>
    function getCookie(name) {
        let re = new RegExp(name + "=([^;]+)");
        let value = re.exec(document.cookie);
        return (value != null) ? unescape(value[1]) : null;
    }

    const csrf_token = getCookie("csrftoken");

    new Vue({
        el: '#app',
        delimiters: ['${','}'],
        data: {
        devices: [],
        visible: false,
        show: false,
        loading: false,
        currentDevice: {},
        message: null,
        properties: [],
        newDevice: {
            name: '',
            properties: []
        }
    },
        mounted () {
        this.initData();
    },
    methods: {
     initData: function() {
        this.getDevices();
        this.getProperties();
     },
    getDevices() {
     this.loading = true;
      this.$http.get('/api/device/')
          .then((response) => {
            this.devices = response.data;
            this.loading = false;
          })
          .catch((err) => {
           this.loading = false;
           console.log(err);
          });
    },
        getProperties(){
               this.$http.get('/api/property/')
          .then((response) => {
            this.properties = response.data;
            this.loading = false;
          })
          .catch((err) => {
           this.loading = false;
           console.log(err);
          })
        },
     getDevice: function(id) {
      this.loading = true;
      this.$http.get(`/api/device/${id}/`)
          .then((response) => {
            this.currentDevice = response.data;
            this.loading = false;
          })
          .catch((err) => {
            this.loading = false;
            console.log(err);
          })
     },
     addDevice () {
      this.loading = true;
      this.visible = true;
      this.$http.post('/api/device/create/', this.newDevice, {
          headers: {'X-CSRFToken':csrf_token},
            })
          .then((response) => {
            this.loading = false;
            this.getDevices();
            this.visible = false;
          })
          .catch((err) => {
            this.loading = false;
            this.visible = false;
            console.log(err);
          })
     },
     updateDevice () {
      this.loading = true;
      this.$http.put(`/api/device/${this.currentDevice.device_id}/`,     this.currentDevice)
          .then((response) => {
            this.loading = false;
            this.currentDevice = response.data;
            this.getDevices();
          })
          .catch((err) => {
            this.loading = false;
            console.log(err);
          })
     },
     deleteDevice (id) {
      this.loading = true;
      this.$http.delete(`/api/device/delete/${id}/` , {
          headers: {'X-CSRFToken':csrf_token},
            })
          .then((response) => {
            this.loading = false;
            this.getDevices();
          })
          .catch((err) => {
            this.loading = false;
            console.log(err);
          })
     }

 }
    ,
    computed: {
            _isValidName() {
                return this.newDevice.name.length <= 0;
            }
    }});

 </script>
</body>
</html>
